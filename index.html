<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Loss Recovery Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        * {
            box-sizing: border-box;
        }
        html, body {
            overflow-x: hidden;
            max-width: 100%;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4 sm:p-8 overflow-x-hidden">
    <div class="max-w-4xl mx-auto w-full">
        <div class="bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 p-4 sm:p-8 w-full overflow-hidden">
            <!-- Header -->
            <div class="flex items-center gap-3 mb-8">
                <div class="bg-red-500/20 p-3 rounded-lg">
                    <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-white">Stock Loss Recovery Calculator</h1>
                    <p class="text-slate-400 mt-1">Calculate shares needed to reach your target loss percentage</p>
                </div>
            </div>

            <!-- Stock Price Fetcher -->
            <div class="bg-slate-700/50 rounded-xl p-4 sm:p-6 mb-6 w-full">
                <label class="block text-sm font-medium text-slate-300 mb-2">Ticker Symbol</label>
                <div class="flex flex-col sm:flex-row gap-3 w-full">
                    <input
                        type="text"
                        id="ticker"
                        placeholder="e.g., AAPL"
                        class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase"
                    />
                    <button
                        id="fetchBtn"
                        class="w-full sm:w-auto sm:min-w-[120px] bg-blue-600 hover:bg-blue-700 disabled:bg-slate-600 text-white px-4 sm:px-6 py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2 whitespace-nowrap"
                    >
                        Get Price
                    </button>
                </div>
                <div id="priceDisplay" class="mt-4 hidden items-center gap-2 text-green-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="font-semibold" id="priceText"></span>
                </div>
            </div>

            <!-- Input Fields -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Average Cost per Share</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3.5 text-slate-400">$</span>
                        <input
                            type="number"
                            id="avgCost"
                            placeholder="0.00"
                            step="0.01"
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg pl-8 pr-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Number of Shares Owned</label>
                    <input
                        type="number"
                        id="numShares"
                        placeholder="0"
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Current Stock Price</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3.5 text-slate-400">$</span>
                        <input
                            type="number"
                            id="currentPrice"
                            placeholder="0.00"
                            step="0.01"
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg pl-8 pr-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Target Loss %</label>
                    <div class="relative">
                        <input
                            type="number"
                            id="targetLoss"
                            placeholder="0"
                            step="0.1"
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 pr-8 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <span class="absolute right-4 top-3.5 text-slate-400">%</span>
                    </div>
                </div>
            </div>

            <!-- Calculate Button -->
            <button
                id="calculateBtn"
                class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white py-4 rounded-lg font-semibold text-lg transition-all flex items-center justify-center gap-2 shadow-lg"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                Calculate Recovery Plan
            </button>

            <!-- Error Message -->
            <div id="errorMsg" class="mt-6 bg-red-500/20 border border-red-500/50 rounded-lg p-4 text-red-300 hidden"></div>

            <!-- Results -->
            <div id="results" class="mt-8 space-y-6 hidden">
                <!-- Current Status -->
                <div class="bg-slate-700/50 rounded-xl p-6">
                    <h3 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                        Current Position
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-300">Current Loss:</span>
                            <span class="text-red-400 font-semibold text-lg" id="currentLossDisplay"></span>
                        </div>
                    </div>
                </div>

                <!-- Recovery Plan -->
                <div id="recoveryPlan" class="bg-gradient-to-br from-blue-600/20 to-blue-700/20 border border-blue-500/30 rounded-xl p-6">
                    <h3 class="text-xl font-semibold text-white mb-4">Recovery Plan</h3>
                    <div id="recoveryContent"></div>
                </div>
            </div>
        </div>

        <!-- Info Footer -->
        <div class="mt-6 text-center text-slate-400 text-sm">
            <p>‚ö†Ô∏è This calculator is for educational purposes only. Not financial advice.</p>
        </div>
    </div>

    <script>
        const API_KEY = '7DZ7HCWLVC9VULCR';
        
        // Elements
        const ticker = document.getElementById('ticker');
        const fetchBtn = document.getElementById('fetchBtn');
        const priceDisplay = document.getElementById('priceDisplay');
        const priceText = document.getElementById('priceText');
        const avgCost = document.getElementById('avgCost');
        const numShares = document.getElementById('numShares');
        const currentPrice = document.getElementById('currentPrice');
        const targetLoss = document.getElementById('targetLoss');
        const calculateBtn = document.getElementById('calculateBtn');
        const errorMsg = document.getElementById('errorMsg');
        const results = document.getElementById('results');
        const currentLossDisplay = document.getElementById('currentLossDisplay');
        const recoveryContent = document.getElementById('recoveryContent');

        // Auto-uppercase ticker input
        ticker.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });

        // Fetch stock price
        fetchBtn.addEventListener('click', async () => {
            const tickerValue = ticker.value.trim();
            if (!tickerValue) {
                showError('Please enter a ticker symbol');
                return;
            }

            fetchBtn.textContent = 'Loading...';
            fetchBtn.disabled = true;
            hideError();
            priceDisplay.classList.add('hidden');

            try {
                const response = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${tickerValue}&apikey=${API_KEY}`);
                const data = await response.json();

                if (data['Global Quote'] && data['Global Quote']['05. price']) {
                    const price = parseFloat(data['Global Quote']['05. price']);
                    currentPrice.value = price.toFixed(2);
                    priceText.textContent = `Current Price: $${price.toFixed(2)}`;
                    priceDisplay.classList.remove('hidden');
                    priceDisplay.classList.add('flex');
                } else if (data['Note']) {
                    showError('API rate limit reached. Please try again later or enter price manually.');
                } else {
                    showError('Unable to fetch stock price. Please check the ticker symbol or enter price manually.');
                }
            } catch (err) {
                showError('Error fetching stock price. Please enter price manually.');
            } finally {
                fetchBtn.textContent = 'Get Price';
                fetchBtn.disabled = false;
            }
        });

        // Calculate shares
        calculateBtn.addEventListener('click', () => {
            const avg = parseFloat(avgCost.value);
            const shares = parseFloat(numShares.value);
            const target = parseFloat(targetLoss.value);
            const current = parseFloat(currentPrice.value);

            if (!avg || !shares || !target || !current) {
                showError('Please fill in all fields');
                return;
            }

            if (avg <= 0 || shares <= 0 || current <= 0) {
                showError('Values must be greater than zero');
                return;
            }

            if (target < 0 || target > 100) {
                showError('Target loss must be between 0 and 100');
                return;
            }

            // Current loss calculation
            const currentTotalCost = avg * shares;
            const currentMarketValue = current * shares;
            const currentLoss = currentTotalCost - currentMarketValue;
            const currentLossPercent = (currentLoss / currentTotalCost) * 100;

            // Target calculations
            const targetLossPercent = target / 100;
            const targetAvgCost = current / (1 - targetLossPercent);
            const additionalShares = (currentTotalCost - (targetAvgCost * shares)) / (targetAvgCost - current);
            
            const newTotalShares = shares + Math.max(0, additionalShares);
            const additionalCost = Math.max(0, additionalShares) * current;
            const newAvgCost = (currentTotalCost + additionalCost) / newTotalShares;
            const newLossPercent = ((newAvgCost - current) / newAvgCost) * 100;

            // Display results
            hideError();
            results.classList.remove('hidden');
            
            currentLossDisplay.textContent = `$${currentLoss.toFixed(2)} (${currentLossPercent.toFixed(2)}%)`;

            if (additionalShares > 0) {
                recoveryContent.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-blue-500/30">
                            <span class="text-slate-300">Additional Shares to Buy:</span>
                            <span class="text-white font-bold text-xl">${Math.ceil(additionalShares)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-blue-500/30">
                            <span class="text-slate-300">Additional Investment:</span>
                            <span class="text-white font-semibold">$${additionalCost.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-blue-500/30">
                            <span class="text-slate-300">New Total Shares:</span>
                            <span class="text-white font-semibold">${newTotalShares.toFixed(0)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-blue-500/30">
                            <span class="text-slate-300">New Average Cost:</span>
                            <span class="text-white font-semibold">$${newAvgCost.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span class="text-slate-300">New Loss Percentage:</span>
                            <span class="text-green-400 font-bold text-xl">${newLossPercent.toFixed(2)}%</span>
                        </div>
                    </div>
                `;
            } else {
                recoveryContent.innerHTML = `
                    <div class="text-center py-6">
                        <p class="text-green-400 font-semibold text-lg">
                            üéâ Your current loss is already within your target!
                        </p>
                        <p class="text-slate-300 mt-2">
                            Current: ${currentLossPercent.toFixed(2)}% | Target: ${target}%
                        </p>
                    </div>
                `;
            }
        });

        function showError(message) {
            errorMsg.textContent = message;
            errorMsg.classList.remove('hidden');
            results.classList.add('hidden');
        }

        function hideError() {
            errorMsg.classList.add('hidden');
        }
    </script>
</body>
</html>
